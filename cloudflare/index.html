<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Bond Classification - POJK 18/2023</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); }
        .gradient-bg { background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 50%, #fefce8 100%); }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 12px 24px -8px rgba(0,0,0,0.1); }
        .upload-zone { 
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 2px dashed #86efac;
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.dragover { 
            border-color: #22c55e; 
            background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
            transform: scale(1.01);
        }
        .fade-up { animation: fadeUp 0.4s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .result-card { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .modal-backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Header -->
    <header class="glass sticky top-0 z-40 border-b border-gray-200/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-green-500/30">GB</div>
                    <div>
                        <h1 class="font-bold text-gray-900">Green Bond Classifier</h1>
                        <p class="text-xs text-gray-500">Based on POJK 18/2023</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">‚ö° Client-Side</span>
                    <button onclick="showView('dashboard')" id="navDashboard" class="nav-btn active px-4 py-2 text-sm font-medium rounded-lg transition-all bg-white text-green-600 shadow-sm">Dashboard</button>
                    <button onclick="showView('table')" id="navTable" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg transition-all text-gray-600 hover:bg-white/50">Data Table</button>
                    <button id="downloadXlsBtn" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-sm font-medium rounded-lg shadow-lg shadow-green-500/30 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Export
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard View -->
    <div id="dashboardView" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Hero Upload Section -->
        <div class="mb-8 fade-up">
            <div class="bg-white rounded-2xl shadow-xl shadow-gray-200/50 overflow-hidden">
                <div class="p-8">
                    <div class="max-w-2xl mx-auto text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Classify Bond Prospectus</h2>
                        <p class="text-gray-500">Upload PDF files to automatically classify bonds based on POJK 18/2023 regulations</p>
                        <p class="text-xs text-blue-600 mt-2">üîí All processing happens in your browser - no data uploaded to server</p>
                    </div>
                    
                    <div id="dropZone" class="upload-zone rounded-2xl p-8 cursor-pointer max-w-2xl mx-auto">
                        <div class="flex flex-col items-center">
                            <div class="w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-green-500/30">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            </div>
                            <p class="text-lg font-semibold text-gray-700 mb-1">Drop PDF files here</p>
                            <p class="text-sm text-gray-500">or click to browse ‚Ä¢ Supports bulk upload</p>
                            <input type="file" id="fileInput" accept=".pdf" multiple class="hidden">
                        </div>
                    </div>

                    <div id="fileList" class="hidden mt-6 max-w-2xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-700">Selected Files</span>
                            <button onclick="clearFiles()" class="text-xs text-red-500 hover:text-red-600">Clear all</button>
                        </div>
                        <div id="fileListItems" class="space-y-2 max-h-32 overflow-y-auto"></div>
                    </div>

                    <div class="mt-6 max-w-2xl mx-auto">
                        <button id="classifyBtn" disabled class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-green-500/30 flex items-center justify-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                            <span id="btnText">Start Classification</span>
                        </button>
                        <div id="progressBar" class="hidden mt-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-2"><span>Processing files...</span><span id="progressText" class="font-medium">0/0</span></div>
                            <div class="h-3 bg-gray-100 rounded-full overflow-hidden"><div id="progressFill" class="h-full bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-300 rounded-full" style="width: 0%"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 fade-up">
            <div class="bg-white rounded-xl p-4 shadow-sm"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-xl">üìä</div><div><p class="text-2xl font-bold text-gray-900" id="statTotal">0</p><p class="text-xs text-gray-500">Total Analyzed</p></div></div></div>
            <div class="bg-white rounded-xl p-4 shadow-sm"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center text-xl">üåø</div><div><p class="text-2xl font-bold text-green-600" id="statGreen">0</p><p class="text-xs text-gray-500">Green Bond</p></div></div></div>
            <div class="bg-white rounded-xl p-4 shadow-sm"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-xl">‚ôªÔ∏è</div><div><p class="text-2xl font-bold text-blue-600" id="statSustain">0</p><p class="text-xs text-gray-500">Sustainability</p></div></div></div>
            <div class="bg-white rounded-xl p-4 shadow-sm"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-xl">üìÑ</div><div><p class="text-2xl font-bold text-gray-600" id="statBiasa">0</p><p class="text-xs text-gray-500">Obligasi Biasa</p></div></div></div>
        </div>

        <!-- Results -->
        <div class="bg-white rounded-2xl shadow-xl shadow-gray-200/50 p-6 fade-up">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-gray-900">Recent Results</h3>
                <button onclick="clearHistory()" class="text-xs text-red-500 hover:text-red-600">Clear History</button>
            </div>
            <div id="emptyState" class="text-center py-12"><div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">üìÅ</div><p class="text-gray-500">No classifications yet</p><p class="text-sm text-gray-400">Upload PDF files to start classifying</p></div>
            <div id="resultsGrid" class="hidden space-y-3 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Table View -->
    <div id="tableView" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-xl shadow-gray-200/50 overflow-hidden fade-up">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Company</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Classification</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Confidence</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Scores</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Pages</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div id="tableEmpty" class="text-center py-12"><p class="text-gray-500">No data available</p></div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <h3 class="font-bold text-lg text-gray-900">Classification Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto max-h-[70vh]"></div>
        </div>
    </div>

    <script>
        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ============================================================================
        // CLASSIFICATION ENGINE (Client-Side)
        // ============================================================================
        const LABEL_DISPLAY = {
            'green_bond': { name: 'Green Bond', emoji: 'üåø', color: '#22c55e' },
            'sustainability_bond': { name: 'Sustainability Bond', emoji: '‚ôªÔ∏è', color: '#3b82f6' },
            'sustainability_linked_bond': { name: 'Sustainability-Linked Bond', emoji: 'üîó', color: '#8b5cf6' },
            'obligasi_biasa': { name: 'Obligasi Biasa', emoji: 'üìÑ', color: '#6b7280' },
        };

        // Keywords with weights (POJK 18/2023)
        const GREEN_KEYWORDS = [
            ['green bond', 10], ['green sukuk', 10], ['obligasi hijau', 10], ['sukuk hijau', 10],
            ['pojk 18/2023', 15], ['pojk 18 tahun 2023', 15], ['pojk18/2023', 15],
            ['pojk 60', 8], ['pojk60', 8], ['kubl', 8],
            ['efek berwawasan lingkungan', 12], ['ebl', 8],
            ['proyek hijau', 5], ['green project', 5],
            ['energi terbarukan', 3], ['renewable energy', 3],
            ['efisiensi energi', 3], ['energy efficiency', 3],
            ['pengelolaan air', 2], ['water management', 2],
            ['pencegahan polusi', 2], ['pollution prevention', 2],
            ['green building', 2], ['bangunan hijau', 2],
            ['transportasi ramah lingkungan', 2], ['clean transportation', 2],
            ['pengelolaan limbah', 2], ['waste management', 2],
            ['adaptasi perubahan iklim', 2], ['climate adaptation', 2],
        ];

        const SUSTAINABILITY_KEYWORDS = [
            ['sustainability bond', 10], ['sustainability sukuk', 10],
            ['obligasi keberlanjutan', 10], ['sukuk keberlanjutan', 10],
            ['ebus keberlanjutan', 10],
            ['proyek sosial', 5], ['social project', 5],
            ['social bond', 5], ['obligasi sosial', 5],
            ['sdgs', 3], ['sustainable development goals', 3],
            ['pembangunan berkelanjutan', 2], ['dampak sosial', 2],
            ['affordable housing', 2], ['perumahan terjangkau', 2],
            ['akses layanan kesehatan', 2], ['healthcare access', 2],
            ['pendidikan', 2], ['education', 2],
            ['ketahanan pangan', 2], ['food security', 2],
        ];

        const SUSTAINABILITY_LINKED_KEYWORDS = [
            ['sustainability linked bond', 10], ['sustainability-linked bond', 10],
            ['sustainability linked sukuk', 10], ['sustainability-linked sukuk', 10],
            ['sustainability performance target', 8], ['spt', 5],
            ['kpi keberlanjutan', 8], ['sustainability kpi', 8],
            ['step-up', 3], ['step-down', 3],
            ['penalty', 2], ['premium', 2],
            ['target kinerja', 2], ['performance target', 2],
        ];

        // Extract text from PDF using PDF.js
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + ' ';
            }
            return { text, pages: pdf.numPages };
        }

        // Extract company name from text
        function extractCompanyName(text, filename) {
            const textSearch = text.substring(0, 10000);
            const patterns = [
                /PROSPEKTUS[^\n]{0,100}?(?:PT\.?\s*)([A-Z][A-Za-z\s\.\,&]+?(?:\s*Tbk\.?)?)\s*(?:\n|$)/i,
                /(?:Emiten|Penerbit)\s*[:\s]+(?:PT\.?\s*)?([A-Z][A-Za-z\s\.\,&]+?(?:\s*Tbk\.?)?)\s*(?:\n|$)/i,
                /\b(PT\.?\s+[A-Z][A-Za-z\s\.\,&]+?\s+Tbk\.?)\b/i,
                /(?:Nama\s+(?:Lengkap|Perusahaan|Emiten|Perseroan))\s*[:\s]+(?:PT\.?\s*)?([A-Z][A-Za-z\s\.\,&]+)/i,
                /\b(PT\.?\s+[A-Z][A-Za-z\s\.\,&]{5,50})\b/i,
            ];
            
            const skipWords = ['prospektus', 'obligasi', 'sukuk', 'indonesia', 'tahun', 'seri', 'dengan'];
            
            for (const pattern of patterns) {
                const matches = textSearch.match(pattern);
                if (matches && matches[1]) {
                    let name = matches[1].trim().replace(/\s+/g, ' ').replace(/[,\.\s]+$/, '');
                    if (name.length < 5 || name.length > 80) continue;
                    if (skipWords.some(sw => name.toLowerCase().includes(sw))) continue;
                    if (!name.toUpperCase().startsWith('PT')) name = 'PT ' + name;
                    return name.toUpperCase();
                }
            }
            return filename.replace('.pdf', '').replace(/[_-]/g, ' ').toUpperCase().substring(0, 60);
        }

        // Calculate keyword score
        function calcScore(text, keywords) {
            const textLower = text.toLowerCase();
            let total = 0;
            const found = [];
            for (const [kw, weight] of keywords) {
                const regex = new RegExp(kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                const matches = textLower.match(regex);
                const count = matches ? matches.length : 0;
                if (count > 0) {
                    total += weight * Math.min(count, 5);
                    found.push({ keyword: kw, count, weight });
                }
            }
            return { total, found };
        }

        // Classify text
        function classifyText(text) {
            const green = calcScore(text, GREEN_KEYWORDS);
            const sustain = calcScore(text, SUSTAINABILITY_KEYWORDS);
            const linked = calcScore(text, SUSTAINABILITY_LINKED_KEYWORDS);

            let label, confidence;
            const maxScore = Math.max(green.total, sustain.total, linked.total);

            if (linked.total >= 10 && linked.total >= sustain.total && linked.total >= green.total) {
                label = 'sustainability_linked_bond';
            } else if (sustain.total >= 10 && sustain.total >= green.total) {
                label = 'sustainability_bond';
            } else if (green.total >= 10) {
                label = 'green_bond';
            } else {
                label = 'obligasi_biasa';
            }

            if (maxScore >= 50) confidence = 0.95;
            else if (maxScore >= 30) confidence = 0.85;
            else if (maxScore >= 10) confidence = 0.70;
            else confidence = 0.50;

            return {
                label,
                confidence,
                scores: { green: green.total, sustainability: sustain.total, linked: linked.total },
                keywords: { green: green.found, sustainability: sustain.found, linked: linked.found }
            };
        }

        // Full classification pipeline
        async function classifyPDF(file) {
            const { text, pages } = await extractTextFromPDF(file);
            const companyName = extractCompanyName(text, file.name);
            const result = classifyText(text);
            const labelInfo = LABEL_DISPLAY[result.label];

            return {
                filename: file.name,
                company_name: companyName,
                classification: {
                    label: result.label,
                    display_name: labelInfo.name,
                    emoji: labelInfo.emoji,
                    color: labelInfo.color,
                    confidence: result.confidence,
                    confidence_level: result.confidence >= 0.8 ? 'high' : result.confidence >= 0.5 ? 'medium' : 'low',
                    method: 'rule-based'
                },
                document_info: { pages, word_count: text.split(/\s+/).length, char_count: text.length },
                scores: result.scores,
                keyword_counts: {
                    green: result.keywords.green.reduce((sum, k) => sum + k.count, 0),
                    sustainability: result.keywords.sustainability.reduce((sum, k) => sum + k.count, 0),
                    linked: result.keywords.linked.reduce((sum, k) => sum + k.count, 0)
                },
                unique_keywords: {
                    green: result.keywords.green.length,
                    sustainability: result.keywords.sustainability.length,
                    linked: result.keywords.linked.length
                },
                keywords_found_str: {
                    green: result.keywords.green.map(k => `${k.keyword} (${k.count}x${k.weight}=${k.count*k.weight})`).join('; '),
                    sustainability: result.keywords.sustainability.map(k => `${k.keyword} (${k.count}x${k.weight}=${k.count*k.weight})`).join('; '),
                    linked: result.keywords.linked.map(k => `${k.keyword} (${k.count}x${k.weight}=${k.count*k.weight})`).join('; ')
                },
                keywords_found: result.keywords,
                regulation: 'POJK 18/2023',
                timestamp: new Date().toISOString()
            };
        }

        // ============================================================================
        // UI CODE
        // ============================================================================
        let selectedFiles = [], history = JSON.parse(localStorage.getItem('gbHistory') || '[]');
        const dropZone = document.getElementById('dropZone'), fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList'), fileListItems = document.getElementById('fileListItems');
        const classifyBtn = document.getElementById('classifyBtn'), btnText = document.getElementById('btnText');
        const progressBar = document.getElementById('progressBar'), progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');

        updateStats(); renderResults(); renderTable();

        function showView(view) {
            document.getElementById('dashboardView').classList.toggle('hidden', view !== 'dashboard');
            document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
            document.getElementById('navDashboard').classList.toggle('active', view === 'dashboard');
            document.getElementById('navDashboard').classList.toggle('bg-white', view === 'dashboard');
            document.getElementById('navDashboard').classList.toggle('text-green-600', view === 'dashboard');
            document.getElementById('navDashboard').classList.toggle('shadow-sm', view === 'dashboard');
            document.getElementById('navDashboard').classList.toggle('text-gray-600', view !== 'dashboard');
            document.getElementById('navTable').classList.toggle('active', view === 'table');
            document.getElementById('navTable').classList.toggle('bg-white', view === 'table');
            document.getElementById('navTable').classList.toggle('text-green-600', view === 'table');
            document.getElementById('navTable').classList.toggle('shadow-sm', view === 'table');
            document.getElementById('navTable').classList.toggle('text-gray-600', view !== 'table');
            if (view === 'table') renderTable();
        }

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) { selectedFiles = [...selectedFiles, ...Array.from(files).filter(f => f.type === 'application/pdf')]; updateFileList(); }
        function clearFiles() { selectedFiles = []; fileInput.value = ''; updateFileList(); }
        function updateFileList() {
            if (selectedFiles.length === 0) { fileList.classList.add('hidden'); classifyBtn.disabled = true; btnText.textContent = 'Start Classification'; return; }
            fileList.classList.remove('hidden'); classifyBtn.disabled = false;
            btnText.textContent = `Classify ${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''}`;
            fileListItems.innerHTML = selectedFiles.map((f, i) => `<div class="flex items-center justify-between bg-gray-50 rounded-lg px-3 py-2"><div class="flex items-center gap-2 min-w-0"><svg class="w-4 h-4 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path d="M4 18h12a2 2 0 002-2V6a2 2 0 00-2-2h-3.93a2 2 0 01-1.66-.9l-.82-1.2A2 2 0 007.93 1H4a2 2 0 00-2 2v13a2 2 0 002 2z"/></svg><span class="text-sm text-gray-700 truncate">${f.name}</span></div><button onclick="removeFile(${i})" class="text-gray-400 hover:text-red-500 ml-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button></div>`).join('');
        }
        function removeFile(index) { selectedFiles.splice(index, 1); updateFileList(); }

        classifyBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;
            classifyBtn.disabled = true; btnText.textContent = 'Processing...'; progressBar.classList.remove('hidden');
            const total = selectedFiles.length; let processed = 0;
            for (const file of selectedFiles) {
                try {
                    const result = await classifyPDF(file);
                    addToHistory(result);
                } catch (err) { console.error('Error processing:', file.name, err); }
                processed++; progressText.textContent = `${processed}/${total}`; progressFill.style.width = `${(processed / total) * 100}%`;
            }
            setTimeout(() => { selectedFiles = []; fileInput.value = ''; updateFileList(); progressBar.classList.add('hidden'); progressFill.style.width = '0%'; btnText.textContent = 'Start Classification'; classifyBtn.disabled = true; }, 1000);
        });

        function addToHistory(data) {
            const companyName = (data.company_name || data.filename.replace('.pdf', '')).toUpperCase();
            const entry = { id: Date.now() + Math.random(), filename: data.filename, company: companyName, label: data.classification.label, displayName: data.classification.display_name, emoji: data.classification.emoji, confidence: data.classification.confidence, confidenceLevel: data.classification.confidence_level, color: data.classification.color, pages: data.document_info?.pages || 0, wordCount: data.document_info?.word_count || 0, charCount: data.document_info?.char_count || 0, scores: data.scores, keywordCounts: data.keyword_counts, uniqueKeywords: data.unique_keywords, keywordsFoundStr: data.keywords_found_str, regulation: 'POJK 18/2023', date: new Date().toISOString() };
            history.unshift(entry); if (history.length > 500) history.pop(); localStorage.setItem('gbHistory', JSON.stringify(history)); updateStats(); renderResults();
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = history.length;
            document.getElementById('statGreen').textContent = history.filter(h => h.label === 'green_bond').length;
            document.getElementById('statSustain').textContent = history.filter(h => h.label === 'sustainability_bond' || h.label === 'sustainability_linked_bond').length;
            document.getElementById('statBiasa').textContent = history.filter(h => h.label === 'obligasi_biasa').length;
        }

        function renderResults() {
            const container = document.getElementById('resultsGrid'), empty = document.getElementById('emptyState');
            if (history.length === 0) { container.classList.add('hidden'); empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden'); container.classList.remove('hidden');
            container.innerHTML = history.slice(0, 20).map(h => `<div onclick="openModal(${h.id})" class="result-card bg-gray-50 hover:bg-gray-100 rounded-xl p-4 cursor-pointer transition-all flex items-center gap-4"><div class="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0" style="background: ${h.color}15"><span class="text-2xl">${h.emoji}</span></div><div class="flex-1 min-w-0"><p class="font-semibold text-gray-900 truncate">${h.company}</p><p class="text-xs text-gray-500 truncate">${h.filename}</p></div><div class="text-right flex-shrink-0"><span class="inline-block px-2.5 py-1 text-xs font-medium rounded-lg" style="background: ${h.color}15; color: ${h.color}">${h.displayName}</span><p class="text-xs text-gray-400 mt-1">${(h.confidence * 100).toFixed(0)}% conf</p></div><svg class="w-5 h-5 text-gray-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>`).join('');
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody'), empty = document.getElementById('tableEmpty');
            if (history.length === 0) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            tbody.innerHTML = history.map(h => `<tr class="hover:bg-gray-50 cursor-pointer" onclick="openModal(${h.id})"><td class="px-4 py-3"><div><p class="font-medium text-gray-900 text-sm">${h.company}</p><p class="text-xs text-gray-500">${h.filename}</p></div></td><td class="px-4 py-3"><span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-lg" style="background: ${h.color}15; color: ${h.color}">${h.emoji} ${h.displayName}</span></td><td class="px-4 py-3"><div class="flex items-center gap-2"><div class="w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden"><div class="h-full rounded-full" style="width: ${h.confidence * 100}%; background: ${h.color}"></div></div><span class="text-xs text-gray-600">${(h.confidence * 100).toFixed(0)}%</span></div></td><td class="px-4 py-3 text-xs text-gray-600"><span class="text-green-600">G:${h.scores?.green || 0}</span> <span class="text-blue-600">S:${h.scores?.sustainability || 0}</span> <span class="text-purple-600">L:${h.scores?.linked || 0}</span></td><td class="px-4 py-3 text-sm text-gray-600">${h.pages}</td><td class="px-4 py-3 text-xs text-gray-500">${new Date(h.date).toLocaleDateString('id-ID')}</td></tr>`).join('');
        }

        function openModal(id) {
            const h = history.find(x => x.id === id); if (!h) return;
            document.getElementById('modalContent').innerHTML = `
                <div class="flex items-start gap-4 mb-6"><div class="w-16 h-16 rounded-2xl flex items-center justify-center flex-shrink-0" style="background: ${h.color}15"><span class="text-4xl">${h.emoji}</span></div><div class="flex-1"><h4 class="text-xl font-bold text-gray-900">${h.company}</h4><p class="text-sm text-gray-500">${h.filename}</p><span class="inline-block mt-2 px-3 py-1 text-sm font-medium rounded-lg" style="background: ${h.color}15; color: ${h.color}">${h.displayName}</span></div></div>
                <div class="grid grid-cols-3 gap-4 mb-6"><div class="bg-gray-50 rounded-xl p-4 text-center"><p class="text-2xl font-bold text-gray-900">${(h.confidence * 100).toFixed(1)}%</p><p class="text-xs text-gray-500">Confidence</p></div><div class="bg-gray-50 rounded-xl p-4 text-center"><p class="text-2xl font-bold text-gray-900">${h.pages}</p><p class="text-xs text-gray-500">Pages</p></div><div class="bg-gray-50 rounded-xl p-4 text-center"><p class="text-2xl font-bold text-gray-900">${(h.wordCount / 1000).toFixed(1)}K</p><p class="text-xs text-gray-500">Words</p></div></div>
                <div class="mb-6"><h5 class="font-semibold text-gray-900 mb-3">Keyword Scores</h5><div class="space-y-3">
                    <div><div class="flex justify-between text-sm mb-1"><span class="text-green-600 font-medium">Green Bond Keywords</span><span class="text-gray-600">${h.scores?.green || 0} pts (${h.uniqueKeywords?.green || 0} unique)</span></div><div class="h-2 bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-green-500 rounded-full" style="width: ${Math.min((h.scores?.green || 0) / 50 * 100, 100)}%"></div></div><p class="text-xs text-gray-500 mt-1">${h.keywordsFoundStr?.green || 'None found'}</p></div>
                    <div><div class="flex justify-between text-sm mb-1"><span class="text-blue-600 font-medium">Sustainability Keywords</span><span class="text-gray-600">${h.scores?.sustainability || 0} pts (${h.uniqueKeywords?.sustainability || 0} unique)</span></div><div class="h-2 bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-blue-500 rounded-full" style="width: ${Math.min((h.scores?.sustainability || 0) / 50 * 100, 100)}%"></div></div><p class="text-xs text-gray-500 mt-1">${h.keywordsFoundStr?.sustainability || 'None found'}</p></div>
                    <div><div class="flex justify-between text-sm mb-1"><span class="text-purple-600 font-medium">Sustainability-Linked Keywords</span><span class="text-gray-600">${h.scores?.linked || 0} pts (${h.uniqueKeywords?.linked || 0} unique)</span></div><div class="h-2 bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-purple-500 rounded-full" style="width: ${Math.min((h.scores?.linked || 0) / 50 * 100, 100)}%"></div></div><p class="text-xs text-gray-500 mt-1">${h.keywordsFoundStr?.linked || 'None found'}</p></div>
                </div></div>
                <div class="text-xs text-gray-400 pt-4 border-t border-gray-100"><p>Regulation: ${h.regulation} ‚Ä¢ Analyzed: ${new Date(h.date).toLocaleString('id-ID')}</p></div>`;
            document.getElementById('detailModal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }
        document.getElementById('detailModal').addEventListener('click', (e) => { if (e.target.id === 'detailModal') closeModal(); });

        function clearHistory() { if (confirm('Clear all classification history?')) { history = []; localStorage.removeItem('gbHistory'); updateStats(); renderResults(); renderTable(); } }

        document.getElementById('downloadXlsBtn').addEventListener('click', () => {
            if (history.length === 0) { alert('No data to export'); return; }
            const data = history.map(h => ({ 'Company': h.company, 'Filename': h.filename, 'Classification': h.displayName, 'Label': h.label, 'Confidence': h.confidence, 'Confidence Level': h.confidenceLevel, 'Green Score': h.scores?.green || 0, 'Sustainability Score': h.scores?.sustainability || 0, 'Linked Score': h.scores?.linked || 0, 'Green Keywords': h.keywordCounts?.green || 0, 'Sustainability Keywords': h.keywordCounts?.sustainability || 0, 'Linked Keywords': h.keywordCounts?.linked || 0, 'Pages': h.pages, 'Word Count': h.wordCount, 'Regulation': h.regulation, 'Date': new Date(h.date).toLocaleString('id-ID') }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Classifications');
            XLSX.writeFile(wb, `bond_classification_${new Date().toISOString().split('T')[0]}.xlsx`);
        });
    </script>
</body>
</html>
