<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Bond Classification - POJK 18/2023</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); }
        .gradient-bg { background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 50%, #fefce8 100%); }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 12px 24px -8px rgba(0,0,0,0.1); }
        .upload-zone { 
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 2px dashed #86efac;
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.dragover { 
            border-color: #22c55e; 
            background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
            transform: scale(1.01);
        }
        .fade-up { animation: fadeUp 0.4s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .result-card { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Header -->
    <header class="glass sticky top-0 z-40 border-b border-gray-200/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-green-500/30">GB</div>
                    <div>
                        <h1 class="font-bold text-gray-900">Green Bond Classifier</h1>
                        <p class="text-xs text-gray-500">Based on POJK 18/2023</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="showView('dashboard')" id="navDashboard" class="nav-btn active px-4 py-2 text-sm font-medium rounded-lg transition-all bg-white text-green-600 shadow-sm">Dashboard</button>
                    <button onclick="showView('table')" id="navTable" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg transition-all text-gray-600 hover:bg-white/50">Data Table</button>
                    <button id="downloadXlsBtn" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-sm font-medium rounded-lg shadow-lg shadow-green-500/30 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Export
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard View -->
    <div id="dashboardView" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Hero Upload Section -->
        <div class="mb-8 fade-up">
            <div class="bg-white rounded-2xl shadow-xl shadow-gray-200/50 overflow-hidden">
                <div class="p-8">
                    <div class="max-w-2xl mx-auto text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Classify Bond Prospectus</h2>
                        <p class="text-gray-500">Upload PDF files to automatically classify bonds based on POJK 18/2023 regulations</p>
                    </div>
                    
                    <div id="dropZone" class="upload-zone rounded-2xl p-8 cursor-pointer max-w-2xl mx-auto">
                        <div class="flex flex-col items-center">
                            <div class="w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-green-500/30">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            </div>
                            <p class="text-lg font-semibold text-gray-700 mb-1">Drop PDF files here</p>
                            <p class="text-sm text-gray-500">or click to browse ‚Ä¢ Supports bulk upload</p>
                            <input type="file" id="fileInput" accept=".pdf" multiple class="hidden">
                        </div>
                    </div>

                    <div id="fileList" class="hidden mt-6 max-w-2xl mx-auto">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-700">Selected Files</span>
                            <button onclick="clearFiles()" class="text-xs text-red-500 hover:text-red-600">Clear all</button>
                        </div>
                        <div id="fileListItems" class="space-y-2 max-h-32 overflow-y-auto"></div>
                    </div>

                    <div class="mt-6 max-w-2xl mx-auto">
                        <button id="classifyBtn" disabled class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-green-500/30 flex items-center justify-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                            <span id="btnText">Start Classification</span>
                        </button>
                        <div id="progressBar" class="hidden mt-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-2"><span>Processing files...</span><span id="progressText" class="font-medium">0/0</span></div>
                            <div class="h-3 bg-gray-100 rounded-full overflow-hidden"><div id="progressFill" class="h-full bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-300 rounded-full" style="width: 0%"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl p-5 shadow-lg shadow-gray-200/50 card-hover">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center"><span class="text-2xl">üìä</span></div>
                    <div><p class="text-sm text-gray-500">Total Analyzed</p><p class="text-2xl font-bold text-gray-900" id="statTotal">0</p></div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-5 shadow-lg shadow-gray-200/50 card-hover border-l-4 border-green-500">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-green-50 rounded-xl flex items-center justify-center"><span class="text-2xl">üåø</span></div>
                    <div><p class="text-sm text-gray-500">Green Bond</p><p class="text-2xl font-bold text-green-600" id="statGreen">0</p></div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-5 shadow-lg shadow-gray-200/50 card-hover border-l-4 border-blue-500">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center"><span class="text-2xl">‚ôªÔ∏è</span></div>
                    <div><p class="text-sm text-gray-500">Sustainability</p><p class="text-2xl font-bold text-blue-600" id="statSustain">0</p></div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-5 shadow-lg shadow-gray-200/50 card-hover border-l-4 border-gray-400">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center"><span class="text-2xl">üìÑ</span></div>
                    <div><p class="text-sm text-gray-500">Regular Bond</p><p class="text-2xl font-bold text-gray-600" id="statBiasa">0</p></div>
                </div>
            </div>
        </div>

        <!-- Recent Results -->
        <div class="bg-white rounded-2xl shadow-xl shadow-gray-200/50 overflow-hidden">
            <div class="px-6 py-5 border-b border-gray-100 flex items-center justify-between">
                <div><h3 class="font-bold text-gray-900">Recent Classifications</h3><p class="text-sm text-gray-500 mt-0.5">Click any result for detailed scoring breakdown</p></div>
                <button id="clearHistory" class="text-sm text-gray-400 hover:text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-50 transition-colors">Clear History</button>
            </div>
            <div id="resultsContainer" class="p-6">
                <div id="emptyState" class="py-16 text-center">
                    <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-2xl flex items-center justify-center"><svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></div>
                    <p class="text-gray-500 font-medium">No classifications yet</p>
                    <p class="text-sm text-gray-400 mt-1">Upload PDF files to get started</p>
                </div>
                <div id="resultsGrid" class="hidden grid gap-3"></div>
            </div>
        </div>
    </div>

    <!-- Table View -->
    <div id="tableView" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-xl shadow-gray-200/50 overflow-hidden">
            <div class="px-6 py-5 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div><h3 class="font-bold text-gray-900">Classification Data</h3><p class="text-sm text-gray-500" id="tableCount">0 records</p></div>
                <select id="filterClass" class="text-sm border border-gray-200 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 bg-gray-50">
                    <option value="">All Classifications</option>
                    <option value="green_bond">üåø Green Bond</option>
                    <option value="sustainability_bond">‚ôªÔ∏è Sustainability Bond</option>
                    <option value="sustainability_linked_bond">üîó Sustainability Linked</option>
                    <option value="obligasi_biasa">üìÑ Obligasi Biasa</option>
                </select>
            </div>
            <div class="overflow-x-auto" style="max-height: calc(100vh - 280px);">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 text-left text-xs text-gray-500 uppercase tracking-wider sticky top-0">
                        <tr>
                            <th class="px-4 py-3 font-semibold">#</th>
                            <th class="px-4 py-3 font-semibold">Company</th>
                            <th class="px-4 py-3 font-semibold">File</th>
                            <th class="px-4 py-3 font-semibold">Classification</th>
                            <th class="px-4 py-3 font-semibold">Confidence</th>
                            <th class="px-4 py-3 font-semibold">Pages</th>
                            <th class="px-4 py-3 font-semibold text-green-600">G</th>
                            <th class="px-4 py-3 font-semibold text-blue-600">S</th>
                            <th class="px-4 py-3 font-semibold text-purple-600">L</th>
                            <th class="px-4 py-3 font-semibold">Date</th>
                        </tr>
                    </thead>
                    <tbody id="fullTableBody" class="divide-y divide-gray-100"></tbody>
                </table>
                <div id="tableEmptyState" class="py-16 text-center"><p class="text-gray-400">No data available</p></div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-gradient-to-r from-gray-50 to-white">
                <div><h3 id="modalTitle" class="font-bold text-gray-900">Classification Detail</h3><p id="modalSubtitle" class="text-sm text-gray-500"></p></div>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-xl transition-colors"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <div id="modalResult" class="mb-6 p-6 rounded-2xl border-2 text-center bg-gradient-to-br from-gray-50 to-white">
                    <span id="modalEmoji" class="text-6xl"></span>
                    <h4 id="modalClass" class="text-2xl font-bold mt-3"></h4>
                    <p id="modalConfidence" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <div class="mb-6">
                    <h5 class="font-semibold text-gray-900 mb-3 flex items-center gap-2"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Document Info</h5>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="bg-gray-50 rounded-xl p-4 text-center"><p class="text-2xl font-bold text-gray-900" id="modalPages">0</p><p class="text-xs text-gray-500 mt-1">Pages</p></div>
                        <div class="bg-gray-50 rounded-xl p-4 text-center"><p class="text-2xl font-bold text-gray-900" id="modalWords">0</p><p class="text-xs text-gray-500 mt-1">Words</p></div>
                        <div class="bg-gray-50 rounded-xl p-4 text-center"><p class="text-2xl font-bold text-gray-900" id="modalChars">0</p><p class="text-xs text-gray-500 mt-1">Characters</p></div>
                        <div class="bg-gray-50 rounded-xl p-4 text-center"><p class="text-sm font-medium text-gray-900" id="modalDate">-</p><p class="text-xs text-gray-500 mt-1">Processed</p></div>
                    </div>
                </div>
                <div class="mb-6">
                    <h5 class="font-semibold text-gray-900 mb-3 flex items-center gap-2"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>Score Comparison</h5>
                    <div class="space-y-4">
                        <div class="bg-green-50 rounded-xl p-4">
                            <div class="flex justify-between items-center mb-2"><span class="font-medium text-green-700 flex items-center gap-2"><span class="text-lg">üåø</span> Green Bond</span><span class="text-xl font-bold text-green-600" id="modalGreenScore">0</span></div>
                            <div class="h-3 bg-green-100 rounded-full overflow-hidden"><div id="modalGreenBar" class="h-full bg-gradient-to-r from-green-400 to-green-500 rounded-full transition-all" style="width: 0%"></div></div>
                        </div>
                        <div class="bg-blue-50 rounded-xl p-4">
                            <div class="flex justify-between items-center mb-2"><span class="font-medium text-blue-700 flex items-center gap-2"><span class="text-lg">‚ôªÔ∏è</span> Sustainability</span><span class="text-xl font-bold text-blue-600" id="modalSustainScore">0</span></div>
                            <div class="h-3 bg-blue-100 rounded-full overflow-hidden"><div id="modalSustainBar" class="h-full bg-gradient-to-r from-blue-400 to-blue-500 rounded-full transition-all" style="width: 0%"></div></div>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-4">
                            <div class="flex justify-between items-center mb-2"><span class="font-medium text-purple-700 flex items-center gap-2"><span class="text-lg">üîó</span> Sustainability-Linked</span><span class="text-xl font-bold text-purple-600" id="modalLinkedScore">0</span></div>
                            <div class="h-3 bg-purple-100 rounded-full overflow-hidden"><div id="modalLinkedBar" class="h-full bg-gradient-to-r from-purple-400 to-purple-500 rounded-full transition-all" style="width: 0%"></div></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3" id="modalScoreExplanation"></p>
                </div>
                <div class="mb-6">
                    <h5 class="font-semibold text-gray-900 mb-3 flex items-center gap-2"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>Classification Rules (POJK 18/2023)</h5>
                    <div class="bg-blue-50 rounded-xl p-4 space-y-2 text-sm">
                        <p id="ruleCheck1" class="flex items-center gap-2 text-blue-800"><span>‚¨ú</span> Sustainability-Linked: Score ‚â• 10 AND highest</p>
                        <p id="ruleCheck2" class="flex items-center gap-2 text-blue-800"><span>‚¨ú</span> Sustainability Bond: Score ‚â• 10 AND ‚â• Green</p>
                        <p id="ruleCheck3" class="flex items-center gap-2 text-blue-800"><span>‚¨ú</span> Green Bond: Score ‚â• 10</p>
                        <p id="ruleCheck4" class="flex items-center gap-2 text-blue-800"><span>‚¨ú</span> Obligasi Biasa: No threshold met</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <h5 class="font-semibold text-gray-900 flex items-center gap-2"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>Keywords Detail</h5>
                    <div class="border border-green-200 rounded-xl overflow-hidden">
                        <div class="bg-green-50 px-4 py-3 flex items-center justify-between"><span class="font-medium text-green-800">üåø Green Bond Keywords</span><span class="text-sm text-green-600" id="greenKwSummary">0 found</span></div>
                        <div class="p-4"><div id="greenKeywordsDetail" class="text-sm"></div></div>
                    </div>
                    <div class="border border-blue-200 rounded-xl overflow-hidden">
                        <div class="bg-blue-50 px-4 py-3 flex items-center justify-between"><span class="font-medium text-blue-800">‚ôªÔ∏è Sustainability Keywords</span><span class="text-sm text-blue-600" id="sustainKwSummary">0 found</span></div>
                        <div class="p-4"><div id="sustainKeywordsDetail" class="text-sm"></div></div>
                    </div>
                    <div class="border border-purple-200 rounded-xl overflow-hidden">
                        <div class="bg-purple-50 px-4 py-3 flex items-center justify-between"><span class="font-medium text-purple-800">üîó Sustainability-Linked Keywords</span><span class="text-sm text-purple-600" id="linkedKwSummary">0 found</span></div>
                        <div class="p-4"><div id="linkedKeywordsDetail" class="text-sm"></div></div>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
                    <h5 class="font-semibold text-amber-800 mb-2 flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Confidence Explanation</h5>
                    <p id="confidenceExplanation" class="text-sm text-amber-700"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let history = JSON.parse(localStorage.getItem('gbHistory') || '[]');
        let selectedFiles = [];

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const fileListItems = document.getElementById('fileListItems');
        const classifyBtn = document.getElementById('classifyBtn');
        const btnText = document.getElementById('btnText');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');

        function showView(view) {
            document.getElementById('dashboardView').classList.toggle('hidden', view !== 'dashboard');
            document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
            document.querySelectorAll('.nav-btn').forEach(btn => { btn.classList.remove('active', 'bg-white', 'text-green-600', 'shadow-sm'); btn.classList.add('text-gray-600', 'hover:bg-white/50'); });
            const activeBtn = document.getElementById(view === 'dashboard' ? 'navDashboard' : 'navTable');
            activeBtn.classList.add('active', 'bg-white', 'text-green-600', 'shadow-sm');
            activeBtn.classList.remove('text-gray-600', 'hover:bg-white/50');
            if (view === 'table') renderFullTable();
        }

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', e => handleFiles(e.target.files));

        function handleFiles(files) { selectedFiles = [...selectedFiles, ...Array.from(files).filter(f => f.type === 'application/pdf')]; updateFileList(); }
        function clearFiles() { selectedFiles = []; fileInput.value = ''; updateFileList(); }
        function updateFileList() {
            if (selectedFiles.length === 0) { fileList.classList.add('hidden'); classifyBtn.disabled = true; btnText.textContent = 'Start Classification'; return; }
            fileList.classList.remove('hidden'); classifyBtn.disabled = false;
            btnText.textContent = `Classify ${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''}`;
            fileListItems.innerHTML = selectedFiles.map((f, i) => `<div class="flex items-center justify-between bg-gray-50 rounded-lg px-3 py-2"><div class="flex items-center gap-2 min-w-0"><svg class="w-4 h-4 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path d="M4 18h12a2 2 0 002-2V6a2 2 0 00-2-2h-3.93a2 2 0 01-1.66-.9l-.82-1.2A2 2 0 007.93 1H4a2 2 0 00-2 2v13a2 2 0 002 2z"/></svg><span class="text-sm text-gray-700 truncate">${f.name}</span></div><button onclick="removeFile(${i})" class="text-gray-400 hover:text-red-500 ml-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button></div>`).join('');
        }
        function removeFile(index) { selectedFiles.splice(index, 1); updateFileList(); }

        classifyBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;
            classifyBtn.disabled = true; btnText.textContent = 'Processing...'; progressBar.classList.remove('hidden');
            const total = selectedFiles.length; let processed = 0;
            for (const file of selectedFiles) {
                try {
                    const formData = new FormData(); formData.append('file', file);
                    const res = await fetch('/classify?method=hybrid', { method: 'POST', body: formData });
                    if (res.ok) addToHistory(await res.json());
                } catch (err) { console.error(err); }
                processed++; progressText.textContent = `${processed}/${total}`; progressFill.style.width = `${(processed / total) * 100}%`;
            }
            setTimeout(() => { selectedFiles = []; fileInput.value = ''; updateFileList(); progressBar.classList.add('hidden'); progressFill.style.width = '0%'; btnText.textContent = 'Start Classification'; classifyBtn.disabled = true; }, 1000);
        });

        function addToHistory(data) {
            const companyName = (data.company_name || data.filename.replace('.pdf', '')).toUpperCase();
            const entry = { id: Date.now() + Math.random(), filename: data.filename, company: companyName, label: data.classification.label, displayName: data.classification.display_name, emoji: data.classification.emoji, confidence: data.classification.confidence, confidenceLevel: data.classification.confidence_level, color: data.classification.color, pages: data.document_info?.pages || 0, wordCount: data.document_info?.word_count || 0, charCount: data.document_info?.char_count || 0, scores: data.scores, keywordCounts: data.keyword_counts, uniqueKeywords: data.unique_keywords, keywordsFoundStr: data.keywords_found_str, regulation: 'POJK 18/2023', date: new Date().toISOString() };
            history.unshift(entry); if (history.length > 500) history.pop(); localStorage.setItem('gbHistory', JSON.stringify(history)); updateStats(); renderResults();
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = history.length;
            document.getElementById('statGreen').textContent = history.filter(h => h.label === 'green_bond').length;
            document.getElementById('statSustain').textContent = history.filter(h => h.label === 'sustainability_bond' || h.label === 'sustainability_linked_bond').length;
            document.getElementById('statBiasa').textContent = history.filter(h => h.label === 'obligasi_biasa').length;
        }

        function renderResults() {
            const container = document.getElementById('resultsGrid'), empty = document.getElementById('emptyState');
            if (history.length === 0) { container.classList.add('hidden'); empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden'); container.classList.remove('hidden');
            container.innerHTML = history.slice(0, 20).map(h => `<div onclick="openModal(${h.id})" class="result-card bg-gray-50 hover:bg-gray-100 rounded-xl p-4 cursor-pointer transition-all flex items-center gap-4"><div class="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0" style="background: ${h.color}15"><span class="text-2xl">${h.emoji}</span></div><div class="flex-1 min-w-0"><p class="font-semibold text-gray-900 truncate">${h.company}</p><p class="text-xs text-gray-500 truncate">${h.filename}</p></div><div class="text-right flex-shrink-0"><span class="inline-block px-2.5 py-1 text-xs font-medium rounded-lg" style="background: ${h.color}15; color: ${h.color}">${h.displayName}</span><p class="text-xs text-gray-400 mt-1">${(h.confidence * 100).toFixed(0)}% conf</p></div><svg class="w-5 h-5 text-gray-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>`).join('');
        }

        function renderFullTable() {
            const tbody = document.getElementById('fullTableBody'), empty = document.getElementById('tableEmptyState'), filter = document.getElementById('filterClass').value;
            let filtered = filter ? history.filter(h => h.label === filter) : history;
            document.getElementById('tableCount').textContent = `${filtered.length} records`;
            if (filtered.length === 0) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            tbody.innerHTML = filtered.map((h, i) => `<tr onclick="openModal(${h.id})" class="hover:bg-gray-50 cursor-pointer transition-colors"><td class="px-4 py-3 text-gray-500">${i + 1}</td><td class="px-4 py-3 font-medium text-gray-900 max-w-[150px] truncate">${h.company}</td><td class="px-4 py-3 text-gray-600 max-w-[120px] truncate">${h.filename}</td><td class="px-4 py-3"><span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-lg" style="background: ${h.color}15; color: ${h.color}">${h.emoji} ${h.displayName}</span></td><td class="px-4 py-3"><div class="flex items-center gap-2"><div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden"><div class="h-full rounded-full" style="width: ${h.confidence * 100}%; background: ${h.color}"></div></div><span class="text-xs text-gray-600">${(h.confidence * 100).toFixed(0)}%</span></div></td><td class="px-4 py-3 text-gray-600">${h.pages || '-'}</td><td class="px-4 py-3 text-green-600 font-medium">${h.scores?.green || 0}</td><td class="px-4 py-3 text-blue-600 font-medium">${h.scores?.sustainability || 0}</td><td class="px-4 py-3 text-purple-600 font-medium">${h.scores?.linked || 0}</td><td class="px-4 py-3 text-gray-500 text-xs">${new Date(h.date).toLocaleDateString('id-ID')}</td></tr>`).join('');
        }

        document.getElementById('filterClass').addEventListener('change', renderFullTable);
        document.getElementById('clearHistory').addEventListener('click', () => { if (confirm('Clear all classification history?')) { history = []; localStorage.removeItem('gbHistory'); updateStats(); renderResults(); renderFullTable(); } });

        function openModal(id) {
            const item = history.find(h => h.id == id); if (!item) return;
            const modal = document.getElementById('detailModal');
            document.getElementById('modalTitle').textContent = item.company;
            document.getElementById('modalSubtitle').textContent = item.filename;
            document.getElementById('modalEmoji').textContent = item.emoji;
            document.getElementById('modalClass').textContent = item.displayName;
            document.getElementById('modalClass').style.color = item.color;
            document.getElementById('modalConfidence').textContent = `${(item.confidence * 100).toFixed(1)}% confidence ‚Ä¢ ${item.confidenceLevel}`;
            document.getElementById('modalResult').style.borderColor = item.color;
            document.getElementById('modalPages').textContent = item.pages || 0;
            document.getElementById('modalWords').textContent = (item.wordCount || 0).toLocaleString();
            document.getElementById('modalChars').textContent = (item.charCount || 0).toLocaleString();
            document.getElementById('modalDate').textContent = new Date(item.date).toLocaleString('id-ID');
            const gScore = item.scores?.green || 0, sScore = item.scores?.sustainability || 0, lScore = item.scores?.linked || 0, maxScore = Math.max(gScore, sScore, lScore, 1);
            document.getElementById('modalGreenScore').textContent = gScore;
            document.getElementById('modalSustainScore').textContent = sScore;
            document.getElementById('modalLinkedScore').textContent = lScore;
            document.getElementById('modalGreenBar').style.width = `${(gScore / maxScore) * 100}%`;
            document.getElementById('modalSustainBar').style.width = `${(sScore / maxScore) * 100}%`;
            document.getElementById('modalLinkedBar').style.width = `${(lScore / maxScore) * 100}%`;
            let scoreExpl = `Threshold: ‚â•10 points. Highest: `;
            if (gScore >= sScore && gScore >= lScore) scoreExpl += `Green (${gScore})`;
            else if (sScore >= lScore) scoreExpl += `Sustainability (${sScore})`;
            else scoreExpl += `Linked (${lScore})`;
            document.getElementById('modalScoreExplanation').textContent = scoreExpl;
            const rules = [{ el: 'ruleCheck1', match: item.label === 'sustainability_linked_bond' }, { el: 'ruleCheck2', match: item.label === 'sustainability_bond' }, { el: 'ruleCheck3', match: item.label === 'green_bond' }, { el: 'ruleCheck4', match: item.label === 'obligasi_biasa' }];
            rules.forEach(r => { const el = document.getElementById(r.el); el.innerHTML = el.innerHTML.replace(/^<span>[‚úÖ‚¨ú]<\/span>/, `<span>${r.match ? '‚úÖ' : '‚¨ú'}</span>`); });
            const gKwCount = item.keywordCounts?.green || 0, sKwCount = item.keywordCounts?.sustainability || 0, lKwCount = item.keywordCounts?.linked || 0;
            document.getElementById('greenKwSummary').textContent = `${gKwCount} occurrences`;
            document.getElementById('sustainKwSummary').textContent = `${sKwCount} occurrences`;
            document.getElementById('linkedKwSummary').textContent = `${lKwCount} occurrences`;
            document.getElementById('greenKeywordsDetail').innerHTML = formatKeywordDetail(item.keywordsFoundStr?.green || '', 'green', gScore);
            document.getElementById('sustainKeywordsDetail').innerHTML = formatKeywordDetail(item.keywordsFoundStr?.sustainability || '', 'blue', sScore);
            document.getElementById('linkedKeywordsDetail').innerHTML = formatKeywordDetail(item.keywordsFoundStr?.linked || '', 'purple', lScore);
            const highestScore = Math.max(gScore, sScore, lScore);
            let confExpl = '';
            if (highestScore >= 50) confExpl = `High confidence: Score ${highestScore} ‚â• 50 indicates strong evidence.`;
            else if (highestScore >= 30) confExpl = `Good confidence: Score ${highestScore} between 30-49 indicates moderate evidence.`;
            else if (highestScore >= 10) confExpl = `Moderate confidence: Score ${highestScore} between 10-29 meets minimum threshold.`;
            else confExpl = `Low confidence: No score reached threshold of 10. Default: Obligasi Biasa.`;
            document.getElementById('confidenceExplanation').textContent = confExpl;
            modal.classList.remove('hidden');
        }

        function formatKeywordDetail(kwStr, colorClass, totalScore) {
            if (!kwStr) return `<p class="text-gray-400 italic">No keywords found</p>`;
            const colors = { 'green': { bg: 'bg-green-100', text: 'text-green-700', score: 'text-green-600' }, 'blue': { bg: 'bg-blue-100', text: 'text-blue-700', score: 'text-blue-600' }, 'purple': { bg: 'bg-purple-100', text: 'text-purple-700', score: 'text-purple-600' } }[colorClass];
            const parts = kwStr.split('; ');
            let html = '<div class="space-y-1">';
            parts.forEach(p => { const match = p.match(/(.+?)\s*\((\d+)x(\d+)=(\d+)\)/); if (match) { const [, kw, count, weight, score] = match; html += `<div class="flex items-center justify-between"><span class="${colors.bg} ${colors.text} px-2 py-0.5 rounded text-xs">${kw.trim()}</span><span class="text-xs text-gray-500">${count}√ó${weight} = <strong class="${colors.score}">+${score}</strong></span></div>`; } });
            html += `</div><div class="mt-2 pt-2 border-t border-gray-100 text-right"><span class="font-bold ${colors.score}">Total: ${totalScore}</span></div>`;
            return html;
        }

        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
        document.getElementById('detailModal').addEventListener('click', e => { if (e.target.id === 'detailModal') closeModal(); });

        document.getElementById('downloadXlsBtn').addEventListener('click', () => {
            if (history.length === 0) return alert('No data to export');
            const data = history.map((h, i) => ({ 'filename': h.filename, 'company_name': h.company, 'processed_at': h.date, 'total_pages': h.pages || 0, 'total_words': h.wordCount || 0, 'green_score': h.scores?.green || 0, 'sustainability_score': h.scores?.sustainability || 0, 'sustainability_linked_score': h.scores?.linked || 0, 'green_keywords_found': h.keywordsFoundStr?.green || '', 'sustainability_keywords_found': h.keywordsFoundStr?.sustainability || '', 'sustainability_linked_keywords_found': h.keywordsFoundStr?.linked || '', 'predicted_class': h.label, 'confidence': h.confidence, 'regulation': h.regulation }));
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Classifications');
            XLSX.writeFile(wb, `green_bond_classification_${new Date().toISOString().slice(0,10)}.xlsx`);
        });

        updateStats(); renderResults();
    </script>
</body>
</html>